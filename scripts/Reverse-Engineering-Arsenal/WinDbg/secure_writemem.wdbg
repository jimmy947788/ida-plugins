$$
$$ Author: Javier Vicente Vallejo
$$ Twitter: @vallejocc
$$ Web: http://www.vallejo.cc
$$
$$     $$>a<secure_writemem.wdbg <start> <end> <process> <targetdir> <ext>
$$
$$ this script tries to dump a range of memory. If its not possible to dump a part of the range, that part if filled with random data
$$ (really its filled with "\x11\x11\x11......\x11\x20\x0d\x0a" (total length 0x1000 for each page filled), but we must not assume it 
$$ will always contain this value 

.printf "secure_writemem.wdbg\r\n"
.printf "${$arg1}\r\n"
.printf "${$arg2}\r\n"
.printf "${$arg3}\r\n"
.printf "${$arg4}\r\n"
.printf "${$arg5}\r\n"

aS swmbase @$t18
aS swmend @$t17
aS swmtemp @$t16

.block
{
    .printf "secure_writemem_1\r\n"

    r ${swmbase} = ${$arg1}
    r ${swmend} = ${$arg2}
    r ${swmtemp} = ${swmbase}

    .printf "secure_writemem_2\r\n"

    .foreach /pS 4 (swmlen_tok { ? (${swmend}-${swmbase}) })
    {
        .printf "secure_writemem_3\r\n"
        
        .block
        {
            .shell -x del ${$arg4}\${$arg3}_${$arg1}_${swmlen_tok}.${$arg5}
        }
        
        .printf "secure_writemem_4\r\n"
        
        .while (${swmtemp} < ${swmend})
        {
            .printf "paging in: %x\n", ${swmtemp}
            .pagein /p ${$arg3} ${swmtemp}
            g
            
            .foreach /pS 4 (swmtemp_tok { ? swmtemp })
            {   
                .printf "secure_writemem_temp_${swmtemp_tok}.bin > ${$arg3}_${$arg1}_${len_tok}.${$arg5}\n"
                .if($vvalid(${swmtemp}, 0x1000)==1)
                {
                    .writemem ${$arg4}\secure_writemem_temp_${swmtemp_tok}.bin ${swmtemp} L 0x1000
                    .shell -x type ${$arg4}\secure_writemem_temp_${swmtemp_tok}.bin >> ${$arg4}\${$arg3}_${$arg1}_${swmlen_tok}.${$arg5} && del ${$arg4}\secure_writemem_temp_${swmtemp_tok}.bin
                }
                .else
                {
                    .printf "invalid address: %x\n", ${swmtemp}
                    
                    .shell -x echo  >> ${$arg4}\${$arg3}_${$arg1}_${swmlen_tok}.${$arg5} && x
                    
                }
            }
            r ${swmtemp} = ${swmtemp} + 0x1000
        }
        
        .printf "secure_writemem_5\r\n"
    }

}

.printf "secure_writemem_6\r\n"
